local MAJOR, MINOR = "S2KTools-1.0", 1

local lib, oldMinor = LibStub:NewLibrary(MAJOR, MINOR)
if not lib then return end

local DEFAULT_PAPERDOLL_NUM_TABS = 3

function unpackByIndex(tab, ...)
	local indexes, res = {...}, {}

	local i, j = 0
	for _, j in pairs(indexes) do
		i = i + 1
		res[i] = tab[j]
	end

	return unpack(res, 1, i)
end

lib.MOUNT_INDEX_TO_SPELL_ID = {
	[6] = 458,	[7] = 459,	[8] = 468,	[9] = 470,	[11] = 472,
	[12] = 578,	[13] = 579,	[14] = 580,	[15] = 581,	[17] = 5784,
	[18] = 6648,	[19] = 6653,	[20] = 6654,	[21] = 6777,	[22] = 6896,
	[24] = 6898,	[25] = 6899,	[26] = 8394,	[27] = 8395,	[28] = 8980,
	[31] = 10789,	[34] = 10793,	[35] = 10795,	[36] = 10796,	[38] = 10799,
	[39] = 10873,	[40] = 10969,	[41] = 13819,	[42] = 15779,	[43] = 15780,
	[45] = 16055,	[46] = 16056,	[50] = 16080,	[51] = 16081,	[52] = 16082,
	[53] = 16083,	[54] = 16084,	[55] = 17229,	[56] = 17450,	[57] = 17453,
	[58] = 17454,	[62] = 17459,	[63] = 17460,	[64] = 17461,	[65] = 17462,
	[66] = 17463,	[67] = 17464,	[68] = 17465,	[69] = 17481,	[70] = 18363,
	[71] = 18989,	[72] = 18990,	[73] = 18991,	[74] = 18992,	[75] = 22717,
	[76] = 22718,	[77] = 22719,	[78] = 22720,	[79] = 22721,	[80] = 22722,
	[81] = 22723,	[82] = 22724,	[83] = 23161,	[84] = 23214,	[85] = 23219,
	[87] = 23221,	[88] = 23222,	[89] = 23223,	[90] = 23225,	[91] = 23227,
	[92] = 23228,	[93] = 23229,	[94] = 23238,	[95] = 23239,	[96] = 23240,
	[97] = 23241,	[98] = 23242,	[99] = 23243,	[100] = 23246,	[101] = 23247,
	[102] = 23248,	[103] = 23249,	[104] = 23250,	[105] = 23251,	[106] = 23252,
	[107] = 23338,	[108] = 23509,	[109] = 23510,	[110] = 24242,	[111] = 24252,
	[116] = 25863,	[117] = 25953,	[118] = 26054,	[119] = 26055,	[120] = 26056,
	[121] = 26655,	[122] = 26656,	[123] = 28828,	[125] = 30174,	[129] = 32235,
	[130] = 32239,	[131] = 32240,	[132] = 32242,	[133] = 32243,	[134] = 32244,
	[135] = 32245,	[136] = 32246,	[137] = 32289,	[138] = 32290,	[139] = 32292,
	[140] = 32295,	[141] = 32296,	[142] = 32297,	[145] = 33630,	[146] = 33660,
	[147] = 34406,	[149] = 34767,	[150] = 34769,	[151] = 34790,	[152] = 34795,
	[153] = 34896,	[154] = 34897,	[155] = 34898,	[156] = 34899,	[157] = 35018,
	[158] = 35020,	[159] = 35022,	[160] = 35025,	[161] = 35027,	[162] = 35028,
	[163] = 35710,	[164] = 35711,	[165] = 35712,	[166] = 35713,	[167] = 35714,
	[168] = 36702,	[169] = 37015,	[170] = 39315,	[171] = 39316,	[172] = 39317,
	[173] = 39318,	[174] = 39319,	[176] = 39798,	[177] = 39800,	[178] = 39801,
	[179] = 39802,	[180] = 39803,	[183] = 40192,	[185] = 41252,	[186] = 41513,
	[187] = 41514,	[188] = 41515,	[189] = 41516,	[190] = 41517,	[191] = 41518,
	[196] = 42776,	[197] = 42777,	[199] = 43688,	[201] = 43899,	[202] = 43900,
	[203] = 43927,	[204] = 44151,	[205] = 44153,	[206] = 44317,	[207] = 44744,
	[211] = 46197,	[212] = 46199,	[213] = 46628,	[219] = 48025,	[220] = 48027,
	[221] = 48778,	[222] = 48954,	[223] = 49193,	[224] = 49322,	[225] = 49378,
	[226] = 49379,	[230] = 51412,	[236] = 54729,	[237] = 54753,	[238] = 55164,
	[240] = 55531,	[241] = 58615,	[242] = 58819,	[243] = 58983,	[246] = 59567,
	[247] = 59568,	[248] = 59569,	[249] = 59570,	[250] = 59571,	[251] = 59572,
	[253] = 59650,	[254] = 59785,	[255] = 59788,	[256] = 59791,	[257] = 59793,
	[258] = 59797,	[259] = 59799,	[262] = 59961,	[263] = 59976,	[264] = 59996,
	[265] = 60002,	[266] = 60021,	[267] = 60024,	[268] = 60025,	[269] = 60114,
	[270] = 60116,	[271] = 60118,	[272] = 60119,	[273] = 60136,	[274] = 60140,
	[275] = 60424,	[276] = 61229,	[277] = 61230,	[278] = 61294,	[279] = 61309,
	[280] = 61425,	[284] = 61447,	[285] = 61451,	[286] = 61465,	[287] = 61467,
	[288] = 61469,	[289] = 61470,	[291] = 61996,	[292] = 61997,	[293] = 62048,
	[294] = 63232,	[295] = 63635,	[296] = 63636,	[297] = 63637,	[298] = 63638,
	[299] = 63639,	[300] = 63640,	[301] = 63641,	[302] = 63642,	[303] = 63643,
	[304] = 63796,	[305] = 63844,	[306] = 63956,	[307] = 63963,	[308] = 64656,
	[309] = 64657,	[310] = 64658,	[311] = 64659,	[312] = 64731,	[313] = 64927,
	[314] = 64977,	[317] = 65439,	[318] = 65637,	[319] = 65638,	[320] = 65639,
	[321] = 65640,	[322] = 65641,	[323] = 65642,	[324] = 65643,	[325] = 65644,
	[326] = 65645,	[327] = 65646,	[328] = 65917,	[329] = 66087,	[330] = 66088,
	[331] = 66090,	[332] = 66091,	[333] = 66122,	[334] = 66123,	[335] = 66124,
	[336] = 66846,	[337] = 66847,	[338] = 66906,	[339] = 66907,	[340] = 67336,
	[341] = 67466,	[342] = 68056,	[343] = 68057,	[344] = 68187,	[345] = 68188,
	[349] = 69395,	[350] = 69820,	[351] = 69826,	[352] = 71342,	[358] = 71810,
	[363] = 72286,	[364] = 72807,	[365] = 72808,	[366] = 73313,	[367] = 73629,
	[368] = 73630,	[371] = 74856,	[372] = 74918,	[373] = 75207,	[375] = 75596,
	[376] = 75614,	[382] = 75973,	[386] = 84751,	[388] = 87090,	[389] = 87091,
	[391] = 88331,	[392] = 88335,	[393] = 88718,	[394] = 88741,	[395] = 88742,
	[396] = 88744,	[397] = 88746,	[398] = 88748,	[399] = 88749,	[400] = 88750,
	[401] = 88990,	[403] = 90621,	[404] = 92155,	[405] = 92231,	[406] = 92232,
	[407] = 93326,	[408] = 93623,	[409] = 93644,	[410] = 96491,	[411] = 96499,
	[412] = 96503,	[413] = 97359,	[415] = 97493,	[416] = 97501,	[417] = 97560,
	[418] = 97581,	[419] = 98204,	[420] = 98718,	[421] = 98727,	[422] = 100332,
	[423] = 100333,	[424] = 101282,	[425] = 101542,	[426] = 101573,	[428] = 101821,
	[429] = 102346,	[430] = 102349,	[431] = 102350,	[432] = 102488,	[433] = 102514,
	[434] = 103081,	[435] = 103195,	[436] = 103196,	[439] = 107203,	[440] = 107516,
	[441] = 107517,	[442] = 107842,	[443] = 107844,	[444] = 107845,	[445] = 110039,
	[446] = 110051,	[447] = 113120,	[448] = 113199,	[449] = 118089,	[450] = 118737,
	[451] = 120043,	[452] = 120395,	[453] = 120822,	[455] = 121820,	[456] = 121836,
	[457] = 121837,	[458] = 121838,	[459] = 121839,	[460] = 122708,	[462] = 123182,
	[463] = 123886,	[464] = 123992,	[465] = 123993,	[466] = 124408,	[467] = 124550,
	[468] = 124659,	[469] = 126507,	[470] = 126508,	[471] = 127154,	[472] = 127156,
	[473] = 127158,	[474] = 127161,	[475] = 127164,	[476] = 127165,	[477] = 127169,
	[478] = 127170,	[479] = 127174,	[480] = 127176,	[481] = 127177,	[484] = 127209,
	[485] = 127213,	[486] = 127216,	[487] = 127220,	[488] = 127271,	[492] = 127286,
	[493] = 127287,	[494] = 127288,	[495] = 127289,	[496] = 127290,	[497] = 127293,
	[498] = 127295,	[499] = 127302,	[500] = 127308,	[501] = 127310,	[503] = 129552,
	[504] = 129918,	[505] = 129932,	[506] = 129934,	[507] = 129935,	[508] = 130086,
	[509] = 130092,	[510] = 130137,	[511] = 130138,	[515] = 130965,	[516] = 130985,
	[517] = 132036,	[518] = 132117,	[519] = 132118,	[520] = 132119,	[521] = 133023,
	[522] = 134359,	[523] = 134573,	[526] = 135416,	[527] = 135418,	[528] = 136163,
	[529] = 136164,	[530] = 136400,	[531] = 136471,	[532] = 136505,	[533] = 138423,
	[534] = 138424,	[535] = 138425,	[536] = 138426,	[537] = 138640,	[538] = 138641,
	[539] = 138642,	[540] = 138643,	[541] = 139407,	[542] = 139442,	[543] = 139448,
	[544] = 139595,	[545] = 140249,	[546] = 140250,	[547] = 142073,	[548] = 142266,
	[549] = 142478,	[550] = 142641,	[551] = 142878,	[554] = 146615,	[555] = 146622,
	[557] = 148392,	[558] = 148396,	[559] = 148417,	[560] = 148428,	[561] = 148476,
	[562] = 148618,	[563] = 148619,	[564] = 148620,	[565] = 148626,	[566] = 148970,
	[567] = 148972,	[568] = 149801,	[571] = 153489,	[593] = 163024,	[594] = 163025,
	[600] = 155741,	[603] = 169952,	[606] = 170347,	[607] = 171436,	[609] = 171617,
	[612] = 171620,	[613] = 171621,	[614] = 171622,	[615] = 171623,	[616] = 171624,
	[617] = 171625,	[618] = 171626,	[619] = 171627,	[621] = 171629,	[623] = 171632,
	[625] = 171634,	[626] = 171635,	[627] = 171636,	[628] = 171637,	[629] = 171638,
	[630] = 171824,	[632] = 171825,	[634] = 171828,	[635] = 171829,	[636] = 171830,
	[637] = 171831,	[638] = 171832,	[639] = 171833,	[640] = 171834,	[641] = 171835,
	[642] = 171836,	[644] = 171838,	[645] = 171839,	[647] = 171841,	[648] = 171842,
	[649] = 171843,	[650] = 171844,	[651] = 171845,	[654] = 171848,	[655] = 171849,
	[657] = 171851,	[664] = 175700,
}

function lib:InjectPaperDollSidebarTab(name, frame, icon, texCoords)
	local tabIndex = #PAPERDOLL_SIDEBARS + 1
	local extraTabs = tabIndex - DEFAULT_PAPERDOLL_NUM_TABS

	PAPERDOLL_SIDEBARS[tabIndex] = { name = name, frame = frame, icon = icon, texCoords = texCoords }

	local tabButton = CreateFrame(
		"Button", "PaperDollSidebarTab" .. tabIndex, PaperDollSidebarTabs,
		"PaperDollSidebarTabTemplate", tabIndex
	)

	tabButton:SetPoint("BOTTOMRIGHT", (extraTabs < 2 and -30) or (extraTabs < 3 and -10) or 0, 0)

	local prevTabButton = _G["PaperDollSidebarTab" .. (tabIndex - 1)]

	prevTabButton:ClearAllPoints()
	prevTabButton:SetPoint("RIGHT", tabButton, "LEFT", -4, 0)

	local prevSetLevel = PaperDollFrame_SetLevel

	PaperDollFrame_SetLevel = function()
		prevSetLevel()

		if CharacterFrameInsetRight:IsVisible() then
			local i
			for i = 1, CharacterLevelText:GetNumPoints() do
				point, relativeTo, relativePoint, xOffset, yOffset = CharacterLevelText:GetPoint(i)

				if point == "CENTER" then
					CharacterLevelText:SetPoint(
						point, relativeTo, relativePoint,
						xOffset - (20 + 10 * extraTabs), yOffset
					)
				end
			end
		end
	end
end

local function HookPetJournal()
	local saved = { search = "" }

	hooksecurefunc(C_PetJournal, "ClearSearchFilter", function() saved.search = "" end)
	hooksecurefunc(C_PetJournal, "SetSearchFilter", function(text) saved.search = text end)

	C_PetJournal.GetSearchFilter = function() return saved.search end
end

if not oldMinor then
	HookPetJournal()
end
